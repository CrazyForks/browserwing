# LLMConfigID ä¸¢å¤±é—®é¢˜ä¿®å¤

## ç”¨æˆ·åé¦ˆ

> "å¦‚æœæ˜¯æ²¡æœ‰å·¥å…·è°ƒç”¨çš„æƒ…å†µ session çš„ llm_config_id æ˜¯æ­£å¸¸çš„ã€‚ä½†æ˜¯æœ‰å·¥å…·è°ƒç”¨çš„è¯ï¼Œllm_config_id ä¼šè¢«è¦†ç›–ä¸ºç©ºï¼Œé‡å¯æœåŠ¡åè®¿é—®å°±ä¸ºç©ºäº†"

## é—®é¢˜æè¿°

### ç°è±¡

**æ²¡æœ‰å·¥å…·è°ƒç”¨çš„æƒ…å†µï¼š**
```
1. åˆ›å»ºä¼šè¯ï¼Œé€‰æ‹©æ¨¡å‹ï¼ˆå¦‚ deepseek-v3ï¼‰
2. å‘é€ç®€å•é—®ç­”ï¼š"ä½ æ˜¯ä»€ä¹ˆæ¨¡å‹"
3. ç³»ç»Ÿä½¿ç”¨ DirectResponse ç›´æ¥å›å¤
4. âœ… é‡å¯æœåŠ¡åï¼Œllm_config_id æ­£å¸¸ä¿å­˜
```

**æœ‰å·¥å…·è°ƒç”¨çš„æƒ…å†µï¼š**
```
1. åˆ›å»ºä¼šè¯ï¼Œé€‰æ‹©æ¨¡å‹ï¼ˆå¦‚ deepseek-v3ï¼‰
2. å‘é€éœ€è¦å·¥å…·çš„ä»»åŠ¡ï¼š"è·å–Bç«™é¦–é¡µå†…å®¹"
3. ç³»ç»Ÿè°ƒç”¨å·¥å…·æ‰§è¡Œ
4. âŒ é‡å¯æœåŠ¡åï¼Œllm_config_id å˜ä¸ºç©ºï¼
```

### å½±å“

```
ç”¨æˆ·åœ¨ä½¿ç”¨å·¥å…·ä»»åŠ¡åï¼š
  â€¢ ä¼šè¯çš„ llm_config_id ä¸¢å¤±
  â€¢ å‰ç«¯æ˜¾ç¤ºä¸º"é»˜è®¤æ¨¡å‹"
  â€¢ ç”¨æˆ·ä¸çŸ¥é“åŸæ¥é€‰æ‹©çš„æ˜¯å“ªä¸ªæ¨¡å‹
  â€¢ ä¼šè¯æ¢å¤æ—¶å¯èƒ½ä½¿ç”¨é”™è¯¯çš„æ¨¡å‹
```

## æ ¹æœ¬åŸå› 

### ä»£ç åˆ†æ

**é—®é¢˜ä»£ç ï¼ˆ`backend/agent/agent.go:1556-1563`ï¼‰ï¼š**

```go
// æœ‰å·¥å…·è°ƒç”¨å®Œæˆåï¼Œæ›´æ–°ä¼šè¯æ—¶é—´æˆ³
dbSession := &models.AgentSession{
    ID:        sessionID,
    CreatedAt: session.CreatedAt,
    UpdatedAt: session.UpdatedAt,
    // âŒ ç¼ºå°‘ LLMConfigID å­—æ®µï¼
}
if err := am.db.SaveAgentSession(dbSession); err != nil {
    logger.Warn(am.ctx, "Failed to update session timestamp: %v", err)
}
```

**SaveAgentSession å®ç°ï¼ˆ`backend/storage/bolt.go:744-758`ï¼‰ï¼š**

```go
func (b *BoltDB) SaveAgentSession(session *models.AgentSession) error {
    session.UpdatedAt = time.Now()
    if session.CreatedAt.IsZero() {
        session.CreatedAt = time.Now()
    }

    return b.db.Update(func(tx *bolt.Tx) error {
        bucket := tx.Bucket(agentSessionsBucket)
        data, err := json.Marshal(session)  // â† å®Œæ•´åºåˆ—åŒ–
        if err != nil {
            return err
        }
        return bucket.Put([]byte(session.ID), data)  // â† å®Œæ•´è¦†ç›–
    })
}
```

### é—®é¢˜åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»ºä¼šè¯æ—¶                                    â”‚
â”‚    LLMConfigID: "llm-deepseek-v3"  âœ…            â”‚
â”‚    ä¿å­˜åˆ°æ•°æ®åº“ âœ…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. å‘é€å·¥å…·ä»»åŠ¡                                  â”‚
â”‚    å†…å­˜ä¸­çš„ session.LLMConfigID ä»ç„¶æ­£å¸¸ âœ…      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. å·¥å…·è°ƒç”¨å®Œæˆåæ›´æ–°ä¼šè¯                        â”‚
â”‚    åˆ›å»ºæ–°çš„ dbSession å¯¹è±¡ï¼š                     â”‚
â”‚      ID:        sessionID           âœ…           â”‚
â”‚      CreatedAt: session.CreatedAt   âœ…           â”‚
â”‚      UpdatedAt: session.UpdatedAt   âœ…           â”‚
â”‚      LLMConfigID: ""                âŒ (é›¶å€¼)    â”‚
â”‚                                                  â”‚
â”‚    è°ƒç”¨ SaveAgentSession(dbSession)ï¼š            â”‚
â”‚      â†’ json.Marshal(dbSession)                   â”‚
â”‚      â†’ LLMConfigID è¢«åºåˆ—åŒ–ä¸ºç©ºå­—ç¬¦ä¸² ""         â”‚
â”‚      â†’ å®Œæ•´è¦†ç›–æ•°æ®åº“ä¸­çš„è®°å½• âŒ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. é‡å¯æœåŠ¡å                                    â”‚
â”‚    ä»æ•°æ®åº“åŠ è½½ï¼š                                â”‚
â”‚      LLMConfigID: ""  âŒ å·²ä¸¢å¤±                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆåªå½±å“å·¥å…·è°ƒç”¨ï¼Ÿ

**æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼ˆDirectResponse è·¯å¾„ï¼‰ï¼š**
```go
// ç®€å•é—®ç­”ä½¿ç”¨ DirectResponseï¼Œç›´æ¥è¿”å›
// ä¸ä¼šæ‰§è¡Œåˆ°ç¬¬ 1556 è¡Œçš„ä¼šè¯æ›´æ–°é€»è¾‘
// âœ… LLMConfigID ä¿æŒä¸å˜
```

**æœ‰å·¥å…·è°ƒç”¨ï¼ˆAgent æ‰§è¡Œè·¯å¾„ï¼‰ï¼š**
```go
needTools:
    // ... Agent æ‰§è¡Œ ...
    
processingComplete:
    // ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯
    // ...
    
    // âŒ æ›´æ–°ä¼šè¯æ—¶é—´æˆ³ï¼ˆç¼ºå°‘ LLMConfigIDï¼‰
    dbSession := &models.AgentSession{
        ID:        sessionID,
        CreatedAt: session.CreatedAt,
        UpdatedAt: session.UpdatedAt,
    }
    am.db.SaveAgentSession(dbSession)  // â† è¦†ç›–äº† LLMConfigID
```

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

```go
// æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
dbSession := &models.AgentSession{
    ID:          sessionID,
    LLMConfigID: session.LLMConfigID, // âœ… æ·»åŠ  LLMConfigID
    CreatedAt:   session.CreatedAt,
    UpdatedAt:   session.UpdatedAt,
}
if err := am.db.SaveAgentSession(dbSession); err != nil {
    logger.Warn(am.ctx, "Failed to update session timestamp: %v", err)
}
```

### åŸç†

```
ç°åœ¨ä¿å­˜åˆ°æ•°æ®åº“çš„å¯¹è±¡ï¼š
{
  "id": "session-123",
  "llm_config_id": "llm-deepseek-v3",  â† âœ… ä¿ç•™åŸå€¼
  "created_at": "2026-01-25T10:00:00Z",
  "updated_at": "2026-01-25T10:05:00Z"
}

åºåˆ—åŒ–åè¦†ç›–æ•°æ®åº“è®°å½•ï¼š
  âœ… LLMConfigID æ­£ç¡®ä¿å­˜
  âœ… é‡å¯åèƒ½æ­£ç¡®æ¢å¤
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºä¼šè¯å¹¶é€‰æ‹©æ¨¡å‹**
   ```
   - é€‰æ‹© deepseek-v3
   - åˆ›å»ºæ–°ä¼šè¯
   ```

2. **å‘é€éœ€è¦å·¥å…·çš„ä»»åŠ¡**
   ```
   é—®é¢˜ï¼š"è·å–Bç«™é¦–é¡µçš„æ¨é€å†…å®¹"
   é¢„æœŸï¼šç³»ç»Ÿè°ƒç”¨ MCP å·¥å…·æ‰§è¡Œ
   ```

3. **æ£€æŸ¥æ•°æ®åº“**
   ```bash
   # æŸ¥çœ‹ä¼šè¯è®°å½•
   # é¢„æœŸ llm_config_id åº”è¯¥ä¿ç•™
   ```

4. **é‡å¯æœåŠ¡**
   ```
   - é‡å¯åç«¯æœåŠ¡
   - åˆ·æ–°å‰ç«¯é¡µé¢
   ```

5. **éªŒè¯ä¼šè¯æ˜¾ç¤º**
   ```
   é¢„æœŸï¼š
   âœ… ä¼šè¯åˆ—è¡¨æ˜¾ç¤ºï¼šdeepseek-v3 (æˆ–åŸé€‰æ‹©çš„æ¨¡å‹)
   âœ… å½“å‰ä¼šè¯æ˜¾ç¤ºï¼šdeepseek-ai/DeepSeek-V3
   
   ä¸åº”è¯¥ï¼š
   âŒ æ˜¾ç¤º"é»˜è®¤æ¨¡å‹"æˆ–ç©ºå€¼
   ```

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | åˆ›å»ºæ—¶æ¨¡å‹ | ä»»åŠ¡ç±»å‹ | é¢„æœŸ llm_config_id |
|------|-----------|---------|-------------------|
| ç®€å•é—®ç­” | deepseek-v3 | DirectResponse | deepseek-v3 âœ… |
| **å·¥å…·ä»»åŠ¡ï¼ˆä¿®å¤å‰ï¼‰** | deepseek-v3 | Agent + å·¥å…· | **ç©º** âŒ |
| **å·¥å…·ä»»åŠ¡ï¼ˆä¿®å¤åï¼‰** | deepseek-v3 | Agent + å·¥å…· | **deepseek-v3** âœ… |
| ä½¿ç”¨é»˜è®¤æ¨¡å‹ | ä¸é€‰æ‹© | ä»»ä½• | ç©ºï¼ˆæ­£å¸¸ï¼‰âœ… |

## å½±å“åˆ†æ

### ä¿®å¤å‰çš„æ•°æ®

```
å·²æœ‰çš„ä¼šè¯ï¼ˆllm_config_id å·²ä¸¢å¤±ï¼‰ï¼š
  â€¢ æ— æ³•è‡ªåŠ¨æ¢å¤
  â€¢ å»ºè®®ï¼šé‡æ–°åˆ›å»ºä¼šè¯
```

### ä¿®å¤åçš„æ•°æ®

```
æ–°åˆ›å»ºçš„ä¼šè¯ï¼š
  âœ… llm_config_id æ­£ç¡®ä¿å­˜
  âœ… å·¥å…·è°ƒç”¨åä¸ä¼šä¸¢å¤±
  âœ… é‡å¯åæ­£ç¡®æ˜¾ç¤º
```

## ä»£ç å˜æ›´

```diff
// backend/agent/agent.go

 // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
 dbSession := &models.AgentSession{
     ID:        sessionID,
+    LLMConfigID: session.LLMConfigID, // âœ… ä¿ç•™ LLMConfigID
     CreatedAt: session.CreatedAt,
     UpdatedAt: session.UpdatedAt,
 }
 if err := am.db.SaveAgentSession(dbSession); err != nil {
     logger.Warn(am.ctx, "Failed to update session timestamp: %v", err)
 }
```

**æ€»è®¡ï¼š** +1 è¡Œå…³é”®ä¿®å¤

## ç›¸å…³é—®é¢˜

### ä¸ºä»€ä¹ˆåˆ›å»ºä¼šè¯æ—¶æ²¡é—®é¢˜ï¼Ÿ

**åˆ›å»ºä¼šè¯ï¼ˆ`agent.go:850-861`ï¼‰ï¼š**

```go
dbSession := &models.AgentSession{
    ID:          session.ID,
    LLMConfigID: llmConfigID,  // âœ… æ­£ç¡®è®¾ç½®
    CreatedAt:   session.CreatedAt,
    UpdatedAt:   session.UpdatedAt,
}
if err := am.db.SaveAgentSession(dbSession); err != nil {
    logger.Warn(am.ctx, "Failed to save session to database: %v", err)
}
```

**åˆ›å»ºæ—¶æ­£ç¡®è®¾ç½®äº† `LLMConfigID`ï¼Œæ‰€ä»¥æ²¡é—®é¢˜** âœ…

### ä¸ºä»€ä¹ˆåªå½±å“å·¥å…·è°ƒç”¨ï¼Ÿ

```
æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SendMessage                         â”‚
â”‚   â†“                                 â”‚
â”‚ evaluateTaskComplexity              â”‚
â”‚   â†“                                 â”‚
â”‚ NeedTools?                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ No  â†’ DirectResponse                â”‚
â”‚       â†’ ç›´æ¥è¿”å›                     â”‚
â”‚       â†’ âœ… ä¸æ›´æ–°ä¼šè¯æ—¶é—´æˆ³          â”‚
â”‚       â†’ âœ… LLMConfigID ä¸å—å½±å“      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Yes â†’ Agent æ‰§è¡Œ                    â”‚
â”‚       â†’ å·¥å…·è°ƒç”¨                     â”‚
â”‚       â†’ processingComplete          â”‚
â”‚       â†’ âŒ æ›´æ–°ä¼šè¯æ—¶é—´æˆ³ï¼ˆæ—§ä»£ç ï¼‰  â”‚
â”‚       â†’ âŒ LLMConfigID ä¸¢å¤±          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç»éªŒæ•™è®­

### 1. éƒ¨åˆ†æ›´æ–° vs å®Œæ•´æ›´æ–°

```
é—®é¢˜ï¼š
  SaveAgentSession æ˜¯å®Œæ•´è¦†ç›–ï¼Œä¸æ˜¯éƒ¨åˆ†æ›´æ–°

æ•™è®­ï¼š
  â€¢ æ›´æ–°æ—¶å¿…é¡»åŒ…å«æ‰€æœ‰å­—æ®µ
  â€¢ æˆ–è€…å®ç°çœŸæ­£çš„éƒ¨åˆ†æ›´æ–°ï¼ˆPATCHï¼‰
```

### 2. æ•°æ®æŒä¹…åŒ–éªŒè¯

```
é—®é¢˜ï¼š
  æ²¡æœ‰éªŒè¯é‡å¯åæ•°æ®æ˜¯å¦å®Œæ•´

æ•™è®­ï¼š
  â€¢ æ¯ä¸ªå…³é”®å­—æ®µéƒ½è¦éªŒè¯æŒä¹…åŒ–
  â€¢ æ·»åŠ é›†æˆæµ‹è¯•éªŒè¯é‡å¯åœºæ™¯
```

### 3. ä¸åŒè·¯å¾„çš„ä¸€è‡´æ€§

```
é—®é¢˜ï¼š
  DirectResponse è·¯å¾„å’Œ Agent è·¯å¾„è¡Œä¸ºä¸ä¸€è‡´

æ•™è®­ï¼š
  â€¢ ç¡®ä¿ä¸åŒè·¯å¾„çš„æ•°æ®å¤„ç†ä¸€è‡´
  â€¢ ä»£ç å®¡æŸ¥æ—¶å…³æ³¨è·¯å¾„å·®å¼‚
```

## æ€»ç»“

### é—®é¢˜
å·¥å…·è°ƒç”¨å `llm_config_id` è¢«è¦†ç›–ä¸ºç©ºï¼Œé‡å¯æœåŠ¡åä¸¢å¤±ã€‚

### åŸå› 
æ›´æ–°ä¼šè¯æ—¶é—´æˆ³æ—¶ï¼Œåˆ›å»ºçš„ `dbSession` å¯¹è±¡ç¼ºå°‘ `LLMConfigID` å­—æ®µï¼Œå¯¼è‡´ä¿å­˜æ—¶è¢«è¦†ç›–ä¸ºç©ºå€¼ã€‚

### è§£å†³æ–¹æ¡ˆ
åœ¨æ›´æ–°ä¼šè¯æ—¶æ·»åŠ  `LLMConfigID: session.LLMConfigID`ï¼Œç¡®ä¿å­—æ®µå€¼è¢«ä¿ç•™ã€‚

### æ•ˆæœ
- âœ… å·¥å…·è°ƒç”¨å `llm_config_id` æ­£ç¡®ä¿å­˜
- âœ… é‡å¯æœåŠ¡åèƒ½æ­£ç¡®æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
- âœ… ç”¨æˆ·ä½“éªŒä¸€è‡´

**ä¸€å¥è¯æ€»ç»“ï¼š** æ›´æ–°ä¼šè¯æ—¶å¿…é¡»åŒ…å«æ‰€æœ‰å…³é”®å­—æ®µï¼Œé¿å…è¦†ç›–ä¸¢å¤±ï¼ğŸ”§âœ¨
