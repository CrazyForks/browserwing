# 会话模型选择 UX 对比

## 快速对比

| 方面 | 旧设计 ❌ | 新设计 ✅ |
|------|----------|----------|
| **选择时机** | 会话中随时 | 新建会话时 |
| **是否可更改** | 看起来可以（实际不行） | 明确不可更改 |
| **只有1个模型** | 仍显示下拉框 | 自动使用，不显示 |
| **多个模型** | 会话中切换 | 新建时选择 |
| **UI元素** | 下拉框（可点击） | 只读标签（信息显示） |
| **概念清晰度** | ❓ 混淆 | ✅ 清晰 |
| **用户困惑** | 高 | 低 |

## 交互流程对比

### 场景 1: 只有一个模型

**旧流程 ❌**
```
1. 点击"新建会话"
2. 进入会话
3. 看到下拉框显示"Claude Sonnet 4"
4. 尝试点击下拉框 → 只有一个选项
5. 困惑：为什么要显示下拉框？
```

**新流程 ✅**
```
1. 点击"新建会话"
2. 自动使用唯一的模型创建会话
3. 会话显示"Claude Sonnet 4"（只读标签）
4. 用户清楚：这个会话使用这个模型
```

### 场景 2: 多个模型

**旧流程 ❌**
```
1. 点击"新建会话"
2. 进入会话
3. 看到下拉框，显示某个模型
4. 不确定：是默认选中的？还是上次用的？
5. 尝试切换模型
6. 发现切换不起作用或行为不明确
7. 困惑：这个功能到底怎么用？
```

**新流程 ✅**
```
1. 点击"新建会话"
2. 弹出对话框："选择模型"
3. 看到提示："会话创建后将使用选定的模型，无法更改"
4. 选择"Claude Sonnet 4"
5. 点击"创建会话"
6. 进入会话，显示"Claude Sonnet 4"（只读）
7. 清楚：这个会话永远使用 Claude Sonnet 4
```

## 视觉对比

### 旧设计（会话中）

```
┌─────────────────────────────────────────────┐
│ Agent Chat              [模型下拉框 ▼]  [新建] │
│                         ↑ 混淆：看起来可切换     │
├─────────────────────────────────────────────┤
│ 消息列表...                                  │
└─────────────────────────────────────────────┘
```

### 新设计（会话中）

```
┌─────────────────────────────────────────────┐
│ Agent Chat      [🤖 Claude Sonnet 4]  [新建] │
│                  ↑ 清晰：只读显示               │
├─────────────────────────────────────────────┤
│ 消息列表...                                  │
└─────────────────────────────────────────────┘
```

### 新设计（新建会话对话框）

```
        ╔═══════════════════════════════╗
        ║      选择模型                  ║
        ╟───────────────────────────────╢
        ║ 会话创建后将使用选定的模型，    ║
        ║ 无法更改                       ║
        ║                               ║
        ║ ┌─────────────────────────┐   ║
        ║ │ ✓ Claude Sonnet 4       │   ║  <- 选中
        ║ │   Anthropic             │   ║
        ║ └─────────────────────────┘   ║
        ║ ┌─────────────────────────┐   ║
        ║ │   GPT-4                 │   ║
        ║ │   OpenAI                │   ║
        ║ └─────────────────────────┘   ║
        ║                               ║
        ║    [取消]    [创建会话]        ║
        ╚═══════════════════════════════╝
```

## 代码变更摘要

### 后端 (3 个文件)

1. **models/agent_session.go**
   - ✅ 添加 `LLMConfigID string` 字段

2. **agent/agent.go**
   - ✅ `ChatSession` 添加 `LLMConfigID` 字段
   - ✅ `CreateSession(llmConfigID string)` 接受参数并保存

3. **agent/handlers.go**
   - ✅ `CreateSession` handler 接受 `llm_config_id` 参数

### 前端 (1 个文件)

**frontend/src/pages/AgentChat.tsx**

**状态变量：**
- ❌ 删除 `selectedLlm`
- ❌ 删除 `showLlmDropdown`
- ❌ 删除 `llmDropdownRef`
- ✅ 添加 `showNewSessionDialog`
- ✅ 添加 `selectedLlmForNewSession`
- ✅ 添加 `newSessionDialogRef`

**接口：**
- ✅ `ChatSession` 添加 `llm_config_id` 字段

**函数：**
- ✅ `showCreateSessionDialog()` - 新建会话逻辑
- ✅ `createSession(llmConfigId)` - 接受模型ID参数
- ✅ `sendMessage()` - 使用 `currentSession.llm_config_id`
- ✅ `loadLLMConfigs()` - 移除自动选择逻辑

**UI 组件：**
- ❌ 删除整个 LLM 下拉框（约60行）
- ✅ 添加只读模型显示（约10行）
- ✅ 添加新建会话对话框（约50行）

## 迁移指南

### 对现有用户的影响

**旧会话（没有 llm_config_id）：**
- ✅ 继续可用
- ✅ 发送消息时使用当前默认配置
- ⚠️ 建议：提示用户旧会话可能行为不一致

**新会话：**
- ✅ 必须绑定模型
- ✅ 行为一致且可预测

### 推荐操作

1. 升级后第一次使用：
   - 删除旧会话，创建新会话
   - 或者：为旧会话补充 `llm_config_id`（数据库更新）

2. 数据库迁移（可选）：
   ```sql
   -- 为旧会话设置默认的 LLM 配置
   UPDATE agent_sessions 
   SET llm_config_id = (SELECT id FROM llm_configs WHERE is_default = true LIMIT 1)
   WHERE llm_config_id = '' OR llm_config_id IS NULL;
   ```

## 总结

这个改进解决了三个核心问题：

1. ✅ **消除歧义**：明确一个会话一个模型
2. ✅ **优化交互**：在正确的时机（新建时）选择模型
3. ✅ **提升体验**：智能显示，减少不必要的操作

用户现在能够：
- ✅ 清楚知道每个会话用什么模型
- ✅ 在新建时做出明智的选择
- ✅ 理解会话的模型不能更改
- ✅ 享受更简洁的界面（只有一个模型时）

**代码质量：**
- ✅ 前端编译成功（无 TypeScript 错误）
- ✅ 后端编译成功（无 Go 错误）
- ✅ 无 linter 警告
- ✅ 代码更简洁（删除了混淆的逻辑）

这是一个显著的 UX 提升！🚀
